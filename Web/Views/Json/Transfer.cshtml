@using SL.Util
@{
    int accountid;
    if (!SL.Web.Service.UserService.CheckAuth(out accountid))
    {
        return;
    }

    RequestUtil req = new RequestUtil();

    if ("list".Equals(Request.QueryString["action"]))
    {
        int page = req.Int("page");
        int pageSize = req.Int("pageSize");
        int type = req.Int("type");
        string keywords = req.String("keywords");

        string where = "b.Deleted=0";
        IList<string> parameters = new List<string>();
        int total;

        if (type == 1)
        {
            where += " and [Type]=1";
        }
        else if (type == 2)
        {
            where += "and [Status]=0";
        }
        else if (type == 3)
        {
            where += "and [Status]=1";
        }

        if (!string.IsNullOrEmpty(keywords))
        {
            where += "and [PlateNumber] like '%'+@p" + parameters.Count + "+'%'";
            parameters.Add(keywords);
        }

        IList<dynamic> data;

        using (SL.Data.Database db = SL.Data.Database.Open())
        {

            data = db.QueryPage("TransferID",
               "AccountID,TransferID,a.ShopID,b.ShopName,PlateNumber,[Type],[Status],CarType,Buyer,BuyerMobile,BuyerAddress,Seller,SellerMobile,SellerAddress,TransferRegion,Price,IsUpload",
               "[Transfer] a join Shop b on a.ShopID=b.ShopID",
               where,
               page,
               pageSize,
               parameters,
               out total,
               new Dictionary<string, bool>{
                { "dbo.Equal(AccountID,"+accountid+")", false }
               });

            if (data != null)
            {
                dynamic item;
                for (int i = 0; i < data.Count; i++)
                {
                    item = data[i];
                    item.Photo = db.QueryValue<string>("select top 1 Photo from [Photo] where TransferID=@p0", item.TransferID);

                    item.Photo = item.Photo != null ? "http://" + Request.Url.Authority + "/compress/" + item.Photo : null;
                    item.Persent = item.Photo != null && item.AccountID != 0 ? "100%" : (item.AccountID != 0 || item.Photo != null) ? "80%" : "60%";
                }
            }
        }

        Json.Write(new { success = true, data = data, total = total }, Output);
    }
    else if ("get".Equals(Request.QueryString["action"]))
    {
        int id = req.Int("id");

        var item = SL.Data.SQL.QuerySingle("select AccountID,TransferID,a.ShopID,b.ShopName,PlateNumber,[Type],[Status],CarType,Buyer,BuyerMobile,BuyerAddress,Seller,SellerMobile,SellerAddress,TransferRegion,Price,IsUpload from [Transfer] a join Shop b on a.ShopID=b.ShopID where b.Deleted=0 and TransferID=@p0", id);

        if (item != null)
        {
            item.Photo = SL.Data.SQL.QueryValue<string>("select top 1 Photo from [Photo] where TransferID=@p0", id);
            item.Photo = item.Photo != null ? "http://" + Request.Url.Authority + "/compress/" + item.Photo : null;
            item.Persent = item.Photo != null && item.AccountID != 0 ? "100%" : (item.AccountID != 0 || item.Photo != null) ? "80%" : "60%";
        }

        Json.Write(new { success = true, data = item }, Output);
    }
    return;
}
